{
  "id": "2022-03-2022-03-25-systemd-migration",
  "url": "/blog/2022/03/01/2022-03-25-systemd-migration/",
  "title": "Linux installation packages migrated from System V init to systemd",
  "date": "2022-03-01",
  "authors": [
    "basil"
  ],
  "tags": [
    "announcement",
    "community",
    "core",
    "platform-sig"
  ],
  "summary": "Starting with Jenkins 2.335, the Jenkins project is migrating from System V init to systemd.",
  "opengraph_image": "/images/logo-title-opengraph.png",
  "content_html": "<div class=\"paragraph\">\n<p>Beginning with Jenkins 2.335 and Jenkins 2.332.1, the Jenkins project is migrating from <a href=\"https://en.wikipedia.org/wiki/Init\">System V <code>init(8)</code></a> to <a href=\"https://www.freedesktop.org/wiki/Software/systemd/\"><code>systemd(1)</code></a> in its official Debian, Red Hat, and openSUSE packages.\nThe <a href=\"https://hub.docker.com/r/jenkins/jenkins\">official Docker image</a> and <a href=\"https://charts.jenkins.io/\">Helm chart</a> remain unchanged.\nFor up-to-date information, refer to the <a href=\"/doc/book/system-administration/systemd-services/\">Managing <code>systemd</code> services</a> page in the documentation.</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"background\"><a class=\"anchor\" href=\"#background\"></a>Background</h3>\n<div class=\"paragraph\">\n<p>Beginning in 2008, the Jenkins (then Hudson) project has delivered Linux OS installation packages for Debian (and derivatives), Red Hat (and derivatives), and openSUSE.\nThese packages were all based on the <a href=\"https://en.wikipedia.org/wiki/Init\">System V <code>init(8)</code></a> system in common use at that time.\nA remnant of the venerable <a href=\"https://en.wikipedia.org/wiki/UNIX_System_V\">Unix System V</a> from 1983, <code>init(8)</code> had remained unchanged for decades.</p>\n</div>\n<div class=\"paragraph\">\n<p>The mid-2000s saw the emergence of a new generation of service management frameworks, starting with the release of <a href=\"https://en.wikipedia.org/wiki/Service_Management_Facility\">Service Management Facility (SMF)</a> in <a href=\"https://en.wikipedia.org/wiki/Oracle_Solaris#Version_history\">Solaris 10</a>, the release of <a href=\"https://en.wikipedia.org/wiki/Launchd\"><code>launchd</code></a> in <a href=\"https://en.wikipedia.org/wiki/Mac_OS_X_Tiger\">Mac OS X Tiger</a>, and the release of <a href=\"https://upstart.ubuntu.com/\">Upstart</a> in <a href=\"https://en.wikipedia.org/wiki/Ubuntu_version_history\">Ubuntu 6.10 (Edgy Eft)</a>.\nIn contrast to the serial service startup of <code>init(8)</code>, these frameworks modeled services as a dependency graph and started services in parallel.</p>\n</div>\n<div class=\"paragraph\">\n<p>The mid-2010s saw the rise of <code>systemd(1)</code> as the dominant service management framework on Linux,\nand it became the default service management framework in <a href=\"https://en.wikipedia.org/wiki/Red_Hat_Enterprise_Linux#RHEL_7\">Red Hat Enterprise Linux (RHEL) 7</a>, <a href=\"https://en.wikipedia.org/wiki/OpenSUSE#Version_history\">openSUSE 12.2 (Mantis)</a>, <a href=\"https://en.wikipedia.org/wiki/Debian_version_history#Debian_8_(Jessie)\">Debian 8 (Jessie)</a>, and <a href=\"https://en.wikipedia.org/wiki/Ubuntu_version_history#Ubuntu_15.04_(Vivid_Vervet)\">Ubuntu 15.04 (Vivid Vervet)</a>.\nA decade after the release of Solaris 10, the ideas behind its service management framework had spread to the majority of Unix-like systems.</p>\n</div>\n<div class=\"paragraph\">\n<p><code>systemd(1)</code> provides compatibility with the behavior exposed by System V <code>init(8)</code>,\nand the System V <code>init(8)</code> scripts delivered in the Jenkins project's official Linux OS packages continued to work in this compatibility mode.\nBeginning with Jenkins 2.335 and Jenkins 2.332.1, the Jenkins project's official Linux OS packages deliver a native <code>systemd(1)</code> <a href=\"https://www.freedesktop.org/software/systemd/man/systemd.service.html\">service unit</a>,\nwhich supersedes the older System V <code>init(8)</code> scripts.\nSeven years after <code>systemd(1)</code> became the default service management framework in the majority of Linux distributions, the Jenkins project provides full support for <code>systemd(1)</code>.</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"motivation\"><a class=\"anchor\" href=\"#motivation\"></a>Motivation</h3>\n<div class=\"paragraph\">\n<p>As defined in W. Richard Stevens' book <a href=\"http://www.kohala.com/start/unp.html\"><em>UNIX Network Programming</em></a> (Addison-Wesley, 1990),\na daemon is \"a process that executes 'in the background' (i.e., without an associated terminal or login shell) either waiting for some event to occur, or waiting to perform some specified task on a periodic basis.\"\nUpon startup, a typical daemon program will:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Close all open <a href=\"https://en.wikipedia.org/wiki/File_descriptor\">file descriptors</a>, including standard input, standard output, and standard error</p>\n</li>\n<li>\n<p>Change its <a href=\"https://en.wikipedia.org/wiki/Working_directory\">working directory</a> to the root filesystem, to ensure that it does not tie up another filesystem and prevent it from being unmounted</p>\n</li>\n<li>\n<p>Reset its file mode creation mask (i.e., <a href=\"https://en.wikipedia.org/wiki/Umask\"><code>umask(2)</code></a>) value</p>\n</li>\n<li>\n<p>Run in the background (i.e., call <a href=\"https://illumos.org/man/2/fork\"><code>fork(2)</code></a>)</p>\n</li>\n<li>\n<p>Disassociate from its <a href=\"https://en.wikipedia.org/wiki/Process_group\">process group</a> (usually a shell), to insulate itself from signals (such as <code>SIGHUP</code>) sent to the process group</p>\n</li>\n<li>\n<p>Ignore all terminal I/O signals</p>\n</li>\n<li>\n<p>Disassociate from the <a href=\"https://en.wikipedia.org/wiki/Controlling_terminal\">controlling terminal</a> (and take steps not to reacquire one)</p>\n</li>\n<li>\n<p>Handle any <code>SIGCLD</code> signals</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>Most programs that are designed to be run as daemons do this work for themselves at startup,\nand Jenkins has traditionally done this using the <a href=\"https://akuma.kohsuke.org/\">Akuma</a> daemonization library and <a href=\"https://github.com/java-native-access/jna\">Java Native Access (JNA)</a>.\nThe Akuma library is no longer actively maintained,\nand recent versions of Java have placed increasingly greater restrictions on the ability of Java programs to access internal system state via reflection and other mechanisms.\nFurthermore, third-party daemonization software like <a href=\"https://software.clapper.org/daemonize/\"><code>daemonize(1)</code></a> is not consistently packaged for all Linux distributions,\nand the packages that exist are frequently unmaintained or have bugs that cause regressions for Jenkins users.\nIn other words, the status quo was increasingly unsustainable.</p>\n</div>\n<div class=\"paragraph\">\n<p>Users have also been requesting <code>systemd(1)</code> support in <a href=\"https://issues.jenkins.io/browse/JENKINS-41218\">JENKINS-41218</a> since January 2017.</p>\n</div>\n<div class=\"paragraph\">\n<p>The migration to <code>systemd(1)</code> eliminates this long-standing pain point\nby relying on <code>systemd(1)</code> to daemonize the Jenkins Java process.\nThis avoids the need for JNA-based tricks in Java,\nand it also unifies our implementation of service management across all Linux distributions.\nFurthermore, it allows for tighter integration between Jenkins core and the service management framework with regard to service startup notification.</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"changes\"><a class=\"anchor\" href=\"#changes\"></a>Changes</h3>\n<div class=\"paragraph\">\n<p>Although <code>systemd(1)</code> has been the default service management framework in the majority of Linux distributions for seven years, some members of our community may not be familiar with its use in the context of managing Jenkins.\nThe following section describes some of the changes in more detail and explains how to perform common system administration tasks.\nFor up-to-date information, refer to the <a href=\"/doc/book/system-administration/systemd-services/\">Managing <code>systemd</code> services</a> page in the documentation.\nSee also the <a href=\"https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units\">DigitalOcean community <code>systemd(1)</code> tutorial</a> to better understand the benefits of <code>systemd(1)</code> and the <code>systemctl(1)</code> command.</p>\n</div>\n<div class=\"sect3\">\n<h4 id=\"package-configuration\"><a class=\"anchor\" href=\"#package-configuration\"></a>Package configuration</h4>\n<div class=\"paragraph\">\n<p>Users who run Jenkins 2.335 or later and 2.332.1 LTS or later through the official Debian, Red Hat, or openSUSE packages are affected by this migration.</p>\n</div>\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\"></i>\n</td>\n<td class=\"content\">\nThe <a href=\"https://hub.docker.com/r/jenkins/jenkins\">official Docker image</a> and <a href=\"https://charts.jenkins.io/\">Helm chart</a> remain unchanged.\n</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>The System V <code>init(8)</code> packages delivered the following configuration files:</p>\n</div>\n<div class=\"dlist\">\n<dl>\n<dt class=\"hdlist1\">Debian</dt>\n<dd>\n<p><code>/etc/default/jenkins</code></p>\n</dd>\n<dt class=\"hdlist1\">Red Hat</dt>\n<dd>\n<p><code>/etc/sysconfig/jenkins</code></p>\n</dd>\n<dt class=\"hdlist1\">openSUSE</dt>\n<dd>\n<p><code>/etc/sysconfig/jenkins</code></p>\n</dd>\n</dl>\n</div>\n<div class=\"paragraph\">\n<p>Each configuration file used a unique format, with the Debian version being radically different from the Red Hat and openSUSE versions.\nFurthermore, manual edits to these files would frequently conflict with updated upstream versions, triggering the package manager to flag the conflict and requiring manual intervention on upgrade.</p>\n</div>\n<div class=\"paragraph\">\n<p>New versions of Jenkins still ship these files and support Linux distributions that do not use <code>systemd(1)</code>.\nAt the time, no actively-supported distributions based on Red Hat or openSUSE are known to use System V <code>init(8)</code>.\nOn such systems, the <code>/etc/sysconfig/jenkins</code> file is left in place but unused at runtime.\nHowever, the Debian package can still be installed on distributions such as <a href=\"https://www.devuan.org/\">Devuan GNU+Linux</a>, which is a fork of Debian without <code>systemd(1)</code>.\nOn such systems, the <code>/etc/default/jenkins</code> file will still be used at runtime.</p>\n</div>\n<div class=\"paragraph\">\n<p>When installed on a modern Linux distribution running <code>systemd(1)</code>, the <code>systemd(1)</code> <a href=\"https://www.freedesktop.org/software/systemd/man/systemd.service.html\">service unit</a> is delivered to:</p>\n</div>\n<div class=\"dlist\">\n<dl>\n<dt class=\"hdlist1\">Debian</dt>\n<dd>\n<p><code>/lib/systemd/system/jenkins.service</code></p>\n</dd>\n<dt class=\"hdlist1\">Red Hat</dt>\n<dd>\n<p><code>/usr/lib/systemd/system/jenkins.service</code></p>\n</dd>\n<dt class=\"hdlist1\">openSUSE</dt>\n<dd>\n<p><code>/usr/lib/systemd/system/jenkins.service</code></p>\n</dd>\n</dl>\n</div>\n<div class=\"paragraph\">\n<p>The main service unit is read-only and not intended to be edited manually.\nIt contains a large notice at the top of the file stating as much.\nThe canonical way to customize the <code>systemd(1)</code> service is to run <code>systemctl edit jenkins</code>,\nwhich creates a <em>new</em> drop-in unit at <code>/etc/systemd/system/jenkins.service.d/override.conf</code>.\nOn a clean install, this drop-in unit does not exist.\nWhen a user first customizes a clean install with <code>systemctl edit jenkins</code>, <code>systemd(1)</code> creates the drop-in unit and allows the user to customize it.\nNote that such customizations must be done in a <code>[Service]</code> section in order to take effect.</p>\n</div>\n<div class=\"admonitionblock warning\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-warning\" title=\"Warning\"></i>\n</td>\n<td class=\"content\">\n<code>systemctl edit jenkins</code> creates the drop-in unit as <code>root</code> with 0644 (<code>-rw-r—&#8203;r--</code>) permissions.\nThe migration logic, on the other hand, creates the drop-in unit as <code>root</code> with 0600 (<code>-rw-------</code>) permissions.\nThis might be of consequence if you store an HTTPS keystore location and/or password in the drop-in unit\nand also run jobs directly on the controller,\na practice which the Jenkins project <a href=\"/doc/book/security/controller-isolation/\">explicitly discourages</a>.\nWhen in doubt, secure the drop-in unit by setting its permissions to 0600 with <code>chmod(1)</code>.\n</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>One benefit of the drop-in unit is that it unifies configuration across all three distributions: Debian, Red Hat, and openSUSE.\nGone are the days of maintaining distribution-specific configuration logic.</p>\n</div>\n<div class=\"paragraph\">\n<p>Also note that the drop-in unit is not overwritten on upgrades.\nGone are the days of getting conflicts in <code>/etc/{default,sysconfig}/jenkins</code> on upgrades,\nat least <em>after</em> the upgrade to a <code>systemd(1)</code>-based package is completed.</p>\n</div>\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\"></i>\n</td>\n<td class=\"content\">\nUnlike the System V <code>init(8)</code> configuration, the <code>override.conf</code> file only contains customizations, not the original defaults.\nUsers who are accustomed to editing an existing set of defaults must refer to the (read-only) service unit side-by-side when editing the drop-in unit\nor use a command like <code>systemctl edit jenkins --full</code>, which copies the original service unit instead of creating a drop-in unit.\n</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>Editing the drop-in unit with <code>systemctl edit jenkins</code> will automatically reload the <code>systemd(1)</code> configuration.\nThe settings will take effect the next time Jenkins is restarted.\nIf you edit the drop-in unit without <code>systemctl(1)</code>, you need to run <code>systemctl daemon-reload</code> for the changes to take effect.</p>\n</div>\n<div class=\"paragraph\">\n<p>A final point to mention about the service unit is its use of specifiers,\nwhich may be unfamiliar to some users.\nThe drop-in unit does not perform shell expansion.\nSpecifiers can insert contextual information (like system hostname, unit name, and operating system kernel release) into the drop-in unit.\nThe <code>systemd(1)</code> documentation contains <a href=\"https://www.freedesktop.org/software/systemd/man/systemd.unit.html#id-1.13.3\">a table of specifiers available in unit files</a>.</p>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"migration\"><a class=\"anchor\" href=\"#migration\"></a>Migration</h4>\n<div class=\"paragraph\">\n<p>The Jenkins project ships logic to automatically migrate the System V <code>init(8)</code> configuration file to the new <code>systemd(1)</code> <code>override.conf</code> format.\nThis migration logic does nothing if an <code>override.conf</code> file already exists,\nwhich would be an indication that the migration script already ran\nor that the user has made their own customizations that should be preserved.\nIf <code>override.conf</code> does not exist, package installation migrates the old System V <code>init(8)</code> configuration file to <code>override.conf</code>.</p>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"logging\"><a class=\"anchor\" href=\"#logging\"></a>Logging</h4>\n<div class=\"paragraph\">\n<p>The <code>systemd(1)</code> package also uses <code>systemd-journald(8)</code> for logging by default.\nRather than creating a log file in <code>/var/log/jenkins/jenkins.log</code>,\nJenkins now logs to the system's journal.\nLog entries may be viewed with <code>journalctl -u jenkins</code>.\nThis is perhaps the most noticeable user-visible change in this migration.</p>\n</div>\n<div class=\"paragraph\">\n<p>See the <a href=\"https://www.digitalocean.com/community/tutorials/how-to-use-journalctl-to-view-and-manipulate-systemd-logs\">DigitalOcean log management tutorial</a> for more detailed information.</p>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"startup-notifications\"><a class=\"anchor\" href=\"#startup-notifications\"></a>Startup notifications</h4>\n<div class=\"paragraph\">\n<p>The System V <code>init(8)</code> logic was asynchronous; i.e., running <code>/etc/init.d/jenkins start</code> would return prior to the completion of Jenkins startup.\nThe <code>systemd(1)</code> logic is synchronous; i.e., running <code>systemctl start jenkins</code> will block until Jenkins signals successful startup.\nThis allows system administrators to write automation to programmatically deploy Jenkins using modern tools like Ansible.</p>\n</div>\n<div class=\"paragraph\">\n<p>Jenkins previously restarted itself after upgrading plugins or via the <code>/restart</code> or <code>/safeRestart</code> endpoints by calling <code>exec(2)</code>.\nThis was fragile and exposed users to a variety of bugs.\nThe <code>systemd(1)</code> implementation allows the main process to exit normally before starting it again from scratch.\nIn addition to eliminating a category of bugs, this also provides more visibility into service startup progress.\nSome examples are shown below.</p>\n</div>\n<div class=\"paragraph\">\n<p>From <code>systemctl status jenkins</code> after upgrading plugins:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">systemctl status jenkins\n● jenkins.service - Jenkins Continuous Integration Server\n     Loaded: loaded (/lib/systemd/system/jenkins.service; enabled; vendor preset: enabled)\n    Drop-In: /etc/systemd/system/jenkins.service.d\n             └─override.conf\n     Active: active (running) […]\n   Main PID: […] (java)\n     Status: \"Restart in 10 seconds\"</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>As Jenkins is being brought down:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">systemctl status jenkins\n● jenkins.service - Jenkins Continuous Integration Server\n     Loaded: loaded (/lib/systemd/system/jenkins.service; enabled; vendor preset: enabled)\n    Drop-In: /etc/systemd/system/jenkins.service.d\n             └─override.conf\n     Active: deactivating (stop-sigterm) since […]\n   Main PID: […] (java)\n     Status: \"Stopping Jenkins\"</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>As Jenkins is starting up:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">systemctl status jenkins\n● jenkins.service - Jenkins Continuous Integration Server\n     Loaded: loaded (/lib/systemd/system/jenkins.service; enabled; vendor preset: enabled)\n    Drop-In: /etc/systemd/system/jenkins.service.d\n             └─override.conf\n     Active: activating (start) since […]\n   Main PID: […] (java)</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>After successful startup:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">systemctl status jenkins\n● jenkins.service - Jenkins Continuous Integration Server\n     Loaded: loaded (/lib/systemd/system/jenkins.service; enabled; vendor preset: enabled)\n    Drop-In: /etc/systemd/system/jenkins.service.d\n             └─override.conf\n     Active: active (running) since […]\n   Main PID: […] (java)</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>If Jenkins does not signal startup completion within a configured time,\nthe service will be considered failed and will be shut down again.\nAs each initialization milestone (i.e., \"Started initialization\", \"Listed all plugins\",\n\"Prepared all plugins\", \"Started all plugins\", \"Augmented all extensions\",\n\"System config loaded\", \"System config adapted\", \"Loaded all jobs\",\n\"Configuration for all jobs updated\", and \"Completed initialization\") is attained,\nthe timeout is extended by the value of the <code>jenkins.model.Jenkins.extendTimeoutSeconds</code> system property (by default, 15 seconds).\nThe timeout can be configured with the <code>TimeoutStartSec</code> directive in the service unit.</p>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"reporting-issues\"><a class=\"anchor\" href=\"#reporting-issues\"></a>Reporting issues</h3>\n<div class=\"paragraph\">\n<p>If you find a regression, please file a bug report in <a href=\"https://issues.jenkins.io/\">Jira</a>.\nWhen reporting an issue, include the following information:</p>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>Use the <code>core</code> component.</p>\n</li>\n<li>\n<p>Provide the name, version, and architecture of the Linux distribution you are using (e.g., Ubuntu 20.04.4 LTS x86_64).</p>\n</li>\n<li>\n<p>Provide the contents of the old System V <code>init(8)</code> configuration in <code>/etc/{default,sysconfig}/jenkins</code>, sanitized as necessary.</p>\n</li>\n<li>\n<p>Provide the contents of the <code>systemd(1)</code> drop-in unit in <code>/etc/systemd/system/jenkins.service.d/override.conf</code>, sanitized as necessary.</p>\n</li>\n<li>\n<p>Provide steps to reproduce the issue <em>from scratch</em> on a minimal Jenkins installation; the scenario should fail when the steps are followed on Jenkins 2.335 or later and pass when the steps are followed on Jenkins 2.334 or earlier.</p>\n</li>\n</ol>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"conclusion\"><a class=\"anchor\" href=\"#conclusion\"></a>Conclusion</h3>\n<div class=\"paragraph\">\n<p>We expect to see a bit of disruption from these changes but hope that in the long run they will save time for core and plugin developers and lead to a more secure and stable tool.\nPlease reach out on the <a href=\"https://groups.google.com/g/jenkinsci-dev\">developers' mailing list</a> with any questions or suggestions.</p>\n</div>\n</div>"
}