{
  "id": "2022-05-2022-05-27-docker-image-new-lifecycle",
  "url": "/blog/2022/05/01/2022-05-27-docker-image-new-lifecycle/",
  "title": "Docker Image: new Exit and Restart Behavior for Controllers",
  "date": "2022-05-01",
  "authors": [
    "dduportal",
    "basil"
  ],
  "tags": [
    "platform",
    "docker"
  ],
  "summary": "The restart behavior of the Docker image for Jenkins controllers changed with the weekly 2.344 and the LTS 2.332.3. Container Engine should control this lifecycle (instead of the jenkins process in the container).",
  "opengraph_image": "/images/docker/dockerJenkins_social.png",
  "content_html": "<div class=\"paragraph\">\n<p>The Jenkins project provides Docker images for controllers (and more).\nBeginning with <a href=\"/changelog/#v2.344\">Jenkins 2.344</a> released April 18, 2022 and <a href=\"/changelog-stable/#v2.332.3\">Jenkins 2.332.3</a> released May 04, 2022, the behavior of the \"Exit\" and \"Restart\" lifecycle of the controller image <code>jenkins/jenkins</code> changed.</p>\n</div>\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\"></i>\n</td>\n<td class=\"content\">\n<div class=\"paragraph\">\n<p>TL;DR; Ensure that you have a Container Restart Policy</p>\n</div>\n<div class=\"paragraph\">\n<p>For quick readers: check the <a href=\"#how-to-add-a-container-restart-policy\">How to Add a Container Restart Policy</a> section for immediate actions to be taken.</p>\n</div>\n</td>\n</tr>\n</table>\n</div>\n<div class=\"sect1\">\n<h2 id=\"application-lifecycle-in-a-container-world\"><a class=\"anchor\" href=\"#application-lifecycle-in-a-container-world\"></a>Application Lifecycle in a Container World</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Jenkins previously restarted itself after upgrading plugins or via the <code>/restart</code> or <code>/safeRestart</code> endpoints by calling <code>exec(2)</code>.\nThis was fragile and exposed users to a variety of bugs.</p>\n</div>\n<div class=\"paragraph\">\n<p>The <code>ExitLifecycle</code> implementation allows the main process to exit normally before starting it again from scratch,\nrelying on the exit code to signal to the container orchestrator that the container ought to be restarted rather than to remain shut down.</p>\n</div>\n<div class=\"paragraph\">\n<p>Avoiding <code>exec(2)</code> from Java code, with all the associated complexity of closing file handles and making low-level system calls via JNA, eliminates exposure to a category of bugs.</p>\n</div>\n<div class=\"paragraph\">\n<p>You can read more about this on the following issues: <a href=\"https://github.com/jenkinsci/jenkins/pull/5899\">jenkinsci/jenkins#5899</a> and <a href=\"https://github.com/jenkinsci/docker/pull/1268\">jenkinsci/docker#1268</a>.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"delegate-restarts-to-the-container-engine\"><a class=\"anchor\" href=\"#delegate-restarts-to-the-container-engine\"></a>Delegate Restarts to the Container Engine</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Since the <a href=\"/changelog/#v2.344\">Jenkins Weekly 2.344</a> and the <a href=\"/changelog-stable/#v2.332.3\">Jenkins LTS 2.332.3</a>, the Docker image for Jenkins controller uses the new lifecycle <code>ExitLifecycle</code> by default.</p>\n</div>\n<div class=\"paragraph\">\n<p>It means that when the Jenkins controller triggers any \"restart\" or \"exit\" event, then its container exits.</p>\n</div>\n<div class=\"paragraph\">\n<p>If you are running Jenkins in a controller as a container, you should add a <a href=\"https://docs.docker.com/config/containers/start-containers-automatically/\">\"container restart policy\"</a> different than <code>none</code> to ensure that the container is restarted automatically.</p>\n</div>\n<div class=\"paragraph\">\n<p>If you are running Jenkins in production in a container, chances are great that you already have a restart policy set and the change will be transparent.\nBut we updated the <a href=\"https://github.com/jenkinsci/docker\">jenkinsci/docker documentation</a> to mention that the flag <code>--restart=on-failure</code> is set when starting a Jenkins controller container.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"how-to-add-a-container-restart-policy\"><a class=\"anchor\" href=\"#how-to-add-a-container-restart-policy\"></a>How to Add a Container Restart Policy</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>If you do not have a <a href=\"https://docs.docker.com/config/containers/start-containers-automatically/\">container restart policy</a> defined, please find the different following methods depending on your container orchestrator:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Docker Engine, Docker Swarm: add the <a href=\"https://docs.docker.com/engine/reference/run/#restart-policies---restart\">flag <code>--restart=on-failure</code></a> to the <code>docker run <â€¦&#8203;> jenkins/jenkins</code> command.</p>\n<div class=\"admonitionblock tip\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-tip\" title=\"Tip\"></i>\n</td>\n<td class=\"content\">\nNo need to create a new container: you can use the command <code>docker update</code> to <a href=\"https://docs.docker.com/engine/reference/commandline/update/#update-a-containers-restart-policy\">update the restart policy of an existing container</a>.\n</td>\n</tr>\n</table>\n</div>\n</li>\n<li>\n<p>Docker Compose: update your <code>docker-compose.yml</code> file to specify the <a href=\"https://docs.docker.com/compose/compose-file/#restart\"><code>restart: on-failure</code> keyword</a> (or the <a href=\"https://docs.docker.com/compose/compose-file/deploy/#restart_policy\"><code>deploy.restart_policy</code></a> if using <code>docker compose deploy</code> to a Docker Swarm cluster)</p>\n</li>\n<li>\n<p>Kubernetes:</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>If you are using the official Jenkins helm-chart, make sure that you are using at least the version <a href=\"https://github.com/jenkinsci/helm-charts/releases/tag/jenkins-3.10.3\"><code>3.10.3</code></a> of the Helm chart and you're good to go, as per <a href=\"https://github.com/jenkinsci/helm-charts/issues/529\">jenkinsci/helm-charts#529</a></p>\n</li>\n<li>\n<p>Otherwise, ensure that you configure the Deployment for Jenkins to specify the <a href=\"https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy\"><code>OnFailure</code> restart policy for the pods</a>. Please note that it's the default policy if unspecified.</p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p>Hashicorp's Nomad: Ensure that you specify a non-empty <a href=\"https://www.nomadproject.io/docs/job-specification/restart\"><code>restart</code> stanza</a>. Please note that the <a href=\"https://www.nomadproject.io/docs/job-specification/restart#restart-parameter-defaults\">default stanza behavior</a> behaves as expected: Jenkins is restarted.</p>\n</li>\n</ul>\n</div>\n</div>\n</div>"
}