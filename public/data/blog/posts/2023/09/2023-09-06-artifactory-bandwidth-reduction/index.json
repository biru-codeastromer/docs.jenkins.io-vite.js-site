{
  "id": "2023-09-2023-09-06-artifactory-bandwidth-reduction",
  "url": "/blog/2023/09/06/2023-09-06-artifactory-bandwidth-reduction/",
  "title": "Stop Caching Maven Central",
  "date": "2023-09-06",
  "authors": [
    "markewaite",
    "dduportal"
  ],
  "tags": [
    "infrastructure",
    "artifactory",
    "jfrog"
  ],
  "summary": "JFrog has been a sponsor of the Jenkins project for many years. We&#8217;re delighted that they continue to sponsor the Jenkins project and continue to provide our artifact hosting service, repo.jenkins-ci.org . Releases, incremental development builds, and snapshots of Jenkins core, Jenkins tooling, Jenkins plugins, and Jenkins infrastructure components are hosted on JFrog Artifactory. The worldwide Jenkins community has beenâ€¦",
  "opengraph_image": "/images/post-images/2023/09/06/2023-09-06-artifactory-bandwidth-reduction.png",
  "content_html": "<div class=\"paragraph\">\n<p><span class=\"image\"><img src=\"/images/post-images/2023/09/06/2023-09-06-artifactory-bandwidth-reduction.png\" alt=\"image\" width=\"839\"></span></p>\n</div>\n<div class=\"paragraph\">\n<p><a href=\"https://jfrog.com/\">JFrog</a> has been a sponsor of the Jenkins project for many years.\nWe&#8217;re delighted that they continue to sponsor the Jenkins project and continue to provide our artifact hosting service, <a href=\"https://repo.jenkins-ci.org\">repo.jenkins-ci.org</a>.</p>\n</div>\n<div class=\"paragraph\">\n<p>Releases, incremental development builds, and snapshots of Jenkins core, Jenkins tooling, Jenkins plugins, and Jenkins infrastructure components are hosted on JFrog Artifactory.\nThe worldwide Jenkins community has been well served for many years by JFrog&#8217;s hosted artifact repository.</p>\n</div>\n<div class=\"sect1\">\n<h2 id=\"maven-central\"><a class=\"anchor\" href=\"#maven-central\"></a>Maven Central</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Effective Thursday September 7, 2023, we will stop caching the Maven Central repository from <a href=\"https://repo.jenkins-ci.org\">repo.jenkins-ci.org</a>.\nThe change will be transparent to Jenkins developers because Apache Maven automatically appends the Maven Central repository to its list of repositories.\nBeginning Thursday September 7, 2023, Jenkins developers will receive Maven Central artifacts from Maven Central instead of receiving them from the Jenkins Artifactory.</p>\n</div>\n<div class=\"paragraph\">\n<p>In case of issues, please open a <a href=\"https://github.com/jenkins-infra/helpdesk/issues/new/choose\">Jenkins help desk ticket</a>.</p>\n</div>\n<div class=\"paragraph\">\n<p>If you&#8217;d like more details of the bandwidth misuse investigation, refer to the <a href=\"https://github.com/jenkins-infra/helpdesk/issues/3599\">help desk ticket</a>.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"bandwidth-misuse-the-long-story\"><a class=\"anchor\" href=\"#bandwidth-misuse-the-long-story\"></a>Bandwidth misuse - the long story</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Bandwidth misuse can happen in many different ways.\nMost of our bandwidth misuse was innocent misconfiguration.\nYou can benefit users, the Jenkins community, and Jenkins sponsors by better configuration.</p>\n</div>\n<div class=\"paragraph\">\n<p>When the bandwidth misuse was not innocent misconfiguration, it was bad programming and bad monitoring of a server.\nYou can benefit users, the Jenkins community, and Jenkins sponsors by monitoring bandwidth used by your servers.</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"correct-tool-configuration\"><a class=\"anchor\" href=\"#correct-tool-configuration\"></a>Correct tool configuration</h3>\n<div class=\"paragraph\">\n<p>Two cases involved a Jenkins tool binary that was being downloaded repeatedly from Artifactory.\nEphemeral Jenkins agents were configured to download the tool every time they started.\nThe download source was configured to read the tar.gz tool installer from the Jenkins Artifactory repository.\nOnce the tool was downloaded from Jenkins Artifactory, it was unpacked, installed, and used.</p>\n</div>\n<div class=\"paragraph\">\n<p>The download process took time because it was reading from the public internet to a local agent.\nThe unpack and install took time because it was performed every time an ephemeral agent started.</p>\n</div>\n<div class=\"paragraph\">\n<p><strong>Please install remote tools onto the agent <em>before</em> connecting the agent to the controller</strong></p>\n</div>\n<div class=\"paragraph\">\n<p><strong>Please download a <em>local copy</em> of the tool if you must download tools onto the agent</strong></p>\n</div>\n<div class=\"paragraph\">\n<p>Don&#8217;t waste the time and bandwidth to download and install a tool from a remote location after the agent starts.\nThe OpenJDK project, Eclipse Temurin project, and the Apache Maven project all thank you for not repeatedly downloading the same binary from their servers.\nJenkins thanks you as well.</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"abuse-reports-to-cloud-providers\"><a class=\"anchor\" href=\"#abuse-reports-to-cloud-providers\"></a>Abuse reports to cloud providers</h3>\n<div class=\"paragraph\">\n<p>Another case involved a rogue server that was repeatedly downloading all versions of the Jenkins war files.\nThat rogue server was using over 20TB per month for its repeated downloads of the same files.</p>\n</div>\n<div class=\"paragraph\">\n<p>We reported the misuse to the abuse reporting service of the cloud provider that was hosting the server.\nThe abuse reporting service told us they would investigate.\nThe cloud provider took no further actions.</p>\n</div>\n<div class=\"paragraph\">\n<p><strong>Please choose cloud providers that <em>honor abuse reports</em></strong></p>\n</div>\n<div class=\"paragraph\">\n<p>We blocked the IP address of that server, hoping that the server would not switch to a new IP address and resume its abusive downloads.\nThe IP block stopped the abusive requests.</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"use-local-caching\"><a class=\"anchor\" href=\"#use-local-caching\"></a>Use local caching</h3>\n<div class=\"paragraph\">\n<p>Another case involved agents from the Jenkins project that were repeatedly downloading dependencies as part of their regular build processes.\nBecause we prefer ephemeral agents, the dependencies were being downloaded to the newly launched agent while it was building Jenkins core and Jenkins plugins.</p>\n</div>\n<div class=\"paragraph\">\n<p>Herve Le Meur and Damien Duportal implemented an <a href=\"https://github.com/jenkins-infra/helm-charts/blob/main/charts/artifact-caching-proxy/templates/nginx-proxy-configmap.yaml\">artifact caching proxy using nginx</a> for each of the cloud providers that host agents for the Jenkins project.\nThe artifact caching proxy is hosted on the same cloud provider that runs the agents.\nIt caches requests from agents running on that cloud provider.</p>\n</div>\n<div class=\"paragraph\">\n<p>Mark Waite&#8217;s home lab appeared in the top 5 consumers in a slightly different case.\nMark corrected job configuration errors in his home lab that were causing individual jobs to download all their dependencies to a job-specific cache folder.\nJob specific caching caused the discs to fill on his agents and wasted bandwidth from the repository server.\nFixing the job configuration error removed that home lab from the list.\nMark implemented a central cache in his home lab in an attempt to prevent the issue in the future.</p>\n</div>\n<div class=\"paragraph\">\n<p><strong>Cache your <em>dependencies</em></strong></p>\n</div>\n<div class=\"paragraph\">\n<p>Use local drives and local servers to cache your dependencies so that they can be downloaded faster.</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"summary\"><a class=\"anchor\" href=\"#summary\"></a>Summary</h3>\n<div class=\"paragraph\">\n<p>We&#8217;ve learned to analyze log files with SQL queries thanks to the <a href=\"https://github.com/basil/artifactory-sql\">Artifactory SQL tool</a> provided by Basil Crow.\nWe upload artifactory logs into a SQLite database and can then use SQL select statements to identify patterns and trends.\nThanks to Basil for a very helpful analysis tool.</p>\n</div>\n<div class=\"paragraph\">\n<p>Special thanks to JFrog for their patience and perseverance while we worked through these improvements.</p>\n</div>\n</div>\n</div>\n</div>"
}